# Centrifuge å®æ—¶èŠå¤©å®¤ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

åŸºäº [Centrifugo](https://centrifugal.dev/) æ„å»ºçš„å®æ—¶èŠå¤©å®¤åº”ç”¨ï¼Œæ”¯æŒï¼š

- å¤šèŠå¤©å®¤ (Channel) ç®¡ç†
- ç”¨æˆ·åŠ å…¥/ç¦»å¼€èŠå¤©å®¤çš„å®æ—¶é€šçŸ¥
- å®æ—¶æ¶ˆæ¯å‘é€å’Œæ¥æ”¶
- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ (Presence)
- æ¶ˆæ¯å†å²è®°å½•

## 2. ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®¢æˆ·ç«¯ (Browser)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    React Frontend Application                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  Chat UI     â”‚  â”‚  User List   â”‚  â”‚  Channel Selector    â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                     â”‚
â”‚                          WebSocket Connection                            â”‚
â”‚                       (centrifuge-js SDK)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Centrifugo Server                                â”‚
â”‚                        (Port 8000 - WebSocket)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Features:                                                        â”‚   â”‚
â”‚  â”‚  â€¢ Channel PUB/SUB          â€¢ Message History                    â”‚   â”‚
â”‚  â”‚  â€¢ Presence (online users)  â€¢ Join/Leave notifications           â”‚   â”‚
â”‚  â”‚  â€¢ JWT Authentication       â€¢ Proxy callbacks to backend         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                     â”‚
â”‚              Proxy Callbacks (HTTP POST)                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚     â”‚ connect  â”‚subscribe â”‚ publish  â”‚   RPC    â”‚                       â”‚
â”‚     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚          â”‚          â”‚          â”‚
           â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Backend Server (Node.js)                            â”‚
â”‚                         (Port 3001 - HTTP)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Proxy Handlers:                                                  â”‚   â”‚
â”‚  â”‚  â€¢ /centrifugo/connect    - ç”¨æˆ·è®¤è¯ï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯               â”‚   â”‚
â”‚  â”‚  â€¢ /centrifugo/subscribe  - éªŒè¯è®¢é˜…æƒé™                         â”‚   â”‚
â”‚  â”‚  â€¢ /centrifugo/publish    - éªŒè¯å¹¶å¤„ç†æ¶ˆæ¯å‘å¸ƒ                   â”‚   â”‚
â”‚  â”‚  â€¢ /centrifugo/rpc        - å¤„ç† RPC è°ƒç”¨                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  REST API:                                                        â”‚   â”‚
â”‚  â”‚  â€¢ POST /api/auth/login   - ç”¨æˆ·ç™»å½•ï¼Œè¿”å› JWT                   â”‚   â”‚
â”‚  â”‚  â€¢ GET  /api/channels     - è·å–å¯ç”¨é¢‘é“åˆ—è¡¨                     â”‚   â”‚
â”‚  â”‚  â€¢ POST /api/channels     - åˆ›å»ºæ–°é¢‘é“                           â”‚   â”‚
â”‚  â”‚  â€¢ POST /api/messages     - é€šè¿‡åç«¯å‘é€æ¶ˆæ¯åˆ° Centrifugo        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                     â”‚
â”‚                      Centrifugo Server API                               â”‚
â”‚                    (publish, presence, history)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Database (Optional)                             â”‚
â”‚                     (SQLite / PostgreSQL / MongoDB)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Tables:                                                          â”‚   â”‚
â”‚  â”‚  â€¢ users     - ç”¨æˆ·ä¿¡æ¯                                          â”‚   â”‚
â”‚  â”‚  â€¢ channels  - é¢‘é“ä¿¡æ¯                                          â”‚   â”‚
â”‚  â”‚  â€¢ messages  - æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 3.1 Centrifugo é…ç½®

```json
{
  "token_hmac_secret_key": "your-secret-key",
  "admin": true,
  "admin_password": "admin-password",
  "admin_secret": "admin-secret",
  "api_key": "your-api-key",
  "allowed_origins": ["http://localhost:3000"],

  "proxy_connect_endpoint": "http://localhost:3001/centrifugo/connect",
  "proxy_connect_timeout": "1s",

  "proxy_subscribe_endpoint": "http://localhost:3001/centrifugo/subscribe",
  "proxy_subscribe_timeout": "1s",

  "proxy_publish_endpoint": "http://localhost:3001/centrifugo/publish",
  "proxy_publish_timeout": "1s",

  "proxy_rpc_endpoint": "http://localhost:3001/centrifugo/rpc",
  "proxy_rpc_timeout": "1s",

  "namespaces": [
    {
      "name": "chat",
      "presence": true,
      "join_leave": true,
      "force_push_join_leave": true,
      "history_size": 100,
      "history_ttl": "300s",
      "force_recovery": true,
      "allow_subscribe_for_client": true,
      "allow_publish_for_subscriber": true,
      "allow_presence_for_subscriber": true,
      "allow_history_for_subscriber": true,
      "proxy_subscribe": true,
      "proxy_publish": true
    }
  ]
}
```

### 3.2 æ•°æ®æµç¨‹

#### 3.2.1 ç”¨æˆ·è¿æ¥æµç¨‹

```
1. ç”¨æˆ·æ‰“å¼€åº”ç”¨ â†’ å‰ç«¯åŠ è½½
2. ç”¨æˆ·ç™»å½• â†’ åç«¯éªŒè¯ â†’ è¿”å› JWT Token
3. å‰ç«¯ä½¿ç”¨ JWT è¿æ¥ Centrifugo
4. Centrifugo è°ƒç”¨ proxy_connect_endpoint éªŒè¯
5. åç«¯éªŒè¯ JWT â†’ è¿”å›ç”¨æˆ·ä¿¡æ¯
6. è¿æ¥å»ºç«‹æˆåŠŸ
```

#### 3.2.2 åŠ å…¥é¢‘é“æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»åŠ å…¥é¢‘é“
2. å‰ç«¯è°ƒç”¨ subscription.subscribe()
3. Centrifugo è°ƒç”¨ proxy_subscribe_endpoint
4. åç«¯éªŒè¯ç”¨æˆ·æƒé™ â†’ è¿”å›å…è®¸/æ‹’ç»
5. è®¢é˜…æˆåŠŸ â†’ Centrifugo å¹¿æ’­ join äº‹ä»¶
6. é¢‘é“å†…æ‰€æœ‰ç”¨æˆ·æ”¶åˆ° join é€šçŸ¥
7. å‰ç«¯æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
```

#### 3.2.3 å‘é€æ¶ˆæ¯æµç¨‹

```
1. ç”¨æˆ·è¾“å…¥æ¶ˆæ¯ â†’ ç‚¹å‡»å‘é€
2. å‰ç«¯è°ƒç”¨ subscription.publish(data)
3. Centrifugo è°ƒç”¨ proxy_publish_endpoint
4. åç«¯éªŒè¯å¹¶å¤„ç†æ¶ˆæ¯:
   - éªŒè¯å†…å®¹
   - æ·»åŠ æ—¶é—´æˆ³ã€æ¶ˆæ¯ID
   - å¯é€‰ï¼šå­˜å‚¨åˆ°æ•°æ®åº“
   - è¿”å›å¤„ç†åçš„æ¶ˆæ¯
5. Centrifugo å¹¿æ’­æ¶ˆæ¯åˆ°é¢‘é“
6. æ‰€æœ‰è®¢é˜…è€…æ”¶åˆ°æ¶ˆæ¯
```

#### 3.2.4 ç¦»å¼€é¢‘é“æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»ç¦»å¼€ / å…³é—­é¡µé¢
2. å‰ç«¯è°ƒç”¨ subscription.unsubscribe()
3. Centrifugo æ£€æµ‹åˆ°å–æ¶ˆè®¢é˜…
4. Centrifugo å¹¿æ’­ leave äº‹ä»¶
5. é¢‘é“å†…å…¶ä»–ç”¨æˆ·æ”¶åˆ° leave é€šçŸ¥
6. å‰ç«¯æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
```

## 4. åç«¯ API è®¾è®¡

### 4.1 REST API

#### ç”¨æˆ·è®¤è¯

```
POST /api/auth/login
Request:  { "username": "string", "password": "string" }
Response: { "token": "jwt-token", "user": { "id": "string", "name": "string" } }

POST /api/auth/register
Request:  { "username": "string", "password": "string", "displayName": "string" }
Response: { "token": "jwt-token", "user": { "id": "string", "name": "string" } }
```

#### é¢‘é“ç®¡ç†

```
GET /api/channels
Response: { "channels": [{ "id": "string", "name": "string", "description": "string" }] }

POST /api/channels
Request:  { "name": "string", "description": "string" }
Response: { "channel": { "id": "string", "name": "string" } }

GET /api/channels/:id/messages
Response: { "messages": [{ "id": "string", "content": "string", "user": {...}, "timestamp": "string" }] }
```

### 4.2 Centrifugo Proxy Endpoints

#### Connect Proxy

```
POST /centrifugo/connect
Request (from Centrifugo):
{
  "client": "client-id",
  "transport": "websocket",
  "protocol": "json",
  "encoding": "json",
  "data": { "token": "jwt-token" }
}

Response:
{
  "result": {
    "user": "user-id",
    "expire_at": 1234567890,
    "info": { "name": "User Name", "avatar": "url" },
    "channels": ["chat:general"]  // è‡ªåŠ¨è®¢é˜…çš„é¢‘é“
  }
}
```

#### Subscribe Proxy

```
POST /centrifugo/subscribe
Request (from Centrifugo):
{
  "client": "client-id",
  "user": "user-id",
  "channel": "chat:room-1",
  "data": {}
}

Response:
{
  "result": {
    "info": { "name": "User Name" },
    "data": { "welcomeMessage": "Welcome to the room!" }
  }
}
// æˆ–æ‹’ç»:
{
  "error": { "code": 403, "message": "Permission denied" }
}
```

#### Publish Proxy

```
POST /centrifugo/publish
Request (from Centrifugo):
{
  "client": "client-id",
  "user": "user-id",
  "channel": "chat:room-1",
  "data": { "text": "Hello!" }
}

Response:
{
  "result": {
    "data": {
      "id": "msg-uuid",
      "text": "Hello!",
      "user": { "id": "user-id", "name": "User Name" },
      "timestamp": "2024-01-15T10:30:00Z"
    }
  }
}
```

#### RPC Proxy

```
POST /centrifugo/rpc
Request (from Centrifugo):
{
  "client": "client-id",
  "user": "user-id",
  "method": "getOnlineUsers",
  "data": { "channel": "chat:room-1" }
}

Response:
{
  "result": {
    "data": {
      "users": [{ "id": "1", "name": "Alice" }, { "id": "2", "name": "Bob" }]
    }
  }
}
```

## 5. å‰ç«¯ç»„ä»¶è®¾è®¡

### 5.1 ç»„ä»¶ç»“æ„

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ App.tsx                 # ä¸»åº”ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ Auth/
â”‚   â”‚   â”œâ”€â”€ LoginForm.tsx       # ç™»å½•è¡¨å•
â”‚   â”‚   â””â”€â”€ RegisterForm.tsx    # æ³¨å†Œè¡¨å•
â”‚   â”œâ”€â”€ Chat/
â”‚   â”‚   â”œâ”€â”€ ChatRoom.tsx        # èŠå¤©å®¤ä¸»å®¹å™¨
â”‚   â”‚   â”œâ”€â”€ MessageList.tsx     # æ¶ˆæ¯åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ MessageItem.tsx     # å•æ¡æ¶ˆæ¯
â”‚   â”‚   â”œâ”€â”€ MessageInput.tsx    # æ¶ˆæ¯è¾“å…¥æ¡†
â”‚   â”‚   â””â”€â”€ TypingIndicator.tsx # æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
â”‚   â”œâ”€â”€ Channel/
â”‚   â”‚   â”œâ”€â”€ ChannelList.tsx     # é¢‘é“åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ ChannelItem.tsx     # å•ä¸ªé¢‘é“
â”‚   â”‚   â””â”€â”€ CreateChannel.tsx   # åˆ›å»ºé¢‘é“
â”‚   â””â”€â”€ User/
â”‚       â”œâ”€â”€ UserList.tsx        # åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
â”‚       â”œâ”€â”€ UserItem.tsx        # å•ä¸ªç”¨æˆ·
â”‚       â””â”€â”€ UserProfile.tsx     # ç”¨æˆ·èµ„æ–™
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useCentrifuge.ts        # Centrifuge è¿æ¥ Hook
â”‚   â”œâ”€â”€ useChannel.ts           # é¢‘é“è®¢é˜… Hook
â”‚   â”œâ”€â”€ usePresence.ts          # åœ¨çº¿çŠ¶æ€ Hook
â”‚   â””â”€â”€ useMessages.ts          # æ¶ˆæ¯ç®¡ç† Hook
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ api.ts                  # REST API å®¢æˆ·ç«¯
â”‚   â””â”€â”€ centrifuge.ts           # Centrifuge å®¢æˆ·ç«¯å°è£…
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ authStore.ts            # è®¤è¯çŠ¶æ€
â”‚   â”œâ”€â”€ channelStore.ts         # é¢‘é“çŠ¶æ€
â”‚   â””â”€â”€ messageStore.ts         # æ¶ˆæ¯çŠ¶æ€
â””â”€â”€ types/
    â””â”€â”€ index.ts                # TypeScript ç±»å‹å®šä¹‰
```

### 5.2 æ ¸å¿ƒ Hook è®¾è®¡

#### useCentrifuge Hook

```typescript
interface UseCentrifugeOptions {
  url: string;
  token: string;
  onConnect?: () => void;
  onDisconnect?: (ctx: DisconnectedContext) => void;
}

function useCentrifuge(options: UseCentrifugeOptions) {
  const [client, setClient] = useState<Centrifuge | null>(null);
  const [connected, setConnected] = useState(false);

  // åˆå§‹åŒ–è¿æ¥
  // ç›‘å¬è¿æ¥çŠ¶æ€
  // è¿”å› client å®ä¾‹å’ŒçŠ¶æ€

  return { client, connected, disconnect };
}
```

#### useChannel Hook

```typescript
interface UseChannelOptions {
  client: Centrifuge;
  channel: string;
  onMessage?: (message: Message) => void;
  onJoin?: (info: JoinInfo) => void;
  onLeave?: (info: LeaveInfo) => void;
}

function useChannel(options: UseChannelOptions) {
  const [subscription, setSubscription] = useState<Subscription | null>(null);
  const [messages, setMessages] = useState<Message[]>([]);
  const [users, setUsers] = useState<User[]>([]);

  // è®¢é˜…é¢‘é“
  // ç›‘å¬æ¶ˆæ¯ã€join/leave äº‹ä»¶
  // æä¾›å‘é€æ¶ˆæ¯æ–¹æ³•

  return { subscription, messages, users, sendMessage, leave };
}
```

### 5.3 UI å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header: Logo | Current User | Logout Button                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   â”‚                                 â”‚                   â”‚
â”‚   Channel List    â”‚         Chat Area               â”‚   Online Users    â”‚
â”‚                   â”‚                                 â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ # general   â”‚  â”‚  â”‚ Message 1                 â”‚  â”‚  â”‚ ğŸŸ¢ Alice    â”‚  â”‚
â”‚  â”‚ # random    â”‚  â”‚  â”‚ Message 2                 â”‚  â”‚  â”‚ ğŸŸ¢ Bob      â”‚  â”‚
â”‚  â”‚ # tech      â”‚  â”‚  â”‚ Message 3                 â”‚  â”‚  â”‚ ğŸŸ¢ Charlie  â”‚  â”‚
â”‚  â”‚             â”‚  â”‚  â”‚ ...                       â”‚  â”‚  â”‚             â”‚  â”‚
â”‚  â”‚ + New       â”‚  â”‚  â”‚                           â”‚  â”‚  â”‚             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚                                 â”‚                   â”‚
â”‚                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                   â”‚
â”‚                   â”‚  â”‚ Type a message... [Send]  â”‚  â”‚                   â”‚
â”‚                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                   â”‚
â”‚                   â”‚                                 â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6. é¡¹ç›®ç»“æ„

```
centrifuge-realtime-message-play/
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ DESIGN.md                    # æœ¬è®¾è®¡æ–‡æ¡£
â”œâ”€â”€ backend/                         # åç«¯æœåŠ¡
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.ts                 # å…¥å£æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts             # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts              # è®¤è¯è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ channels.ts          # é¢‘é“è·¯ç”±
â”‚   â”‚   â”‚   â””â”€â”€ centrifugo.ts        # Centrifugo proxy è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts              # è®¤è¯æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ channel.ts           # é¢‘é“æœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ centrifugo.ts        # Centrifugo API å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â””â”€â”€ auth.ts              # JWT éªŒè¯ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ types/
â”‚   â”‚       â””â”€â”€ index.ts             # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ data/
â”‚       â””â”€â”€ db.json                  # ç®€å• JSON æ•°æ®å­˜å‚¨
â”œâ”€â”€ frontend/                        # å‰ç«¯åº”ç”¨
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ main.tsx                 # å…¥å£æ–‡ä»¶
â”‚       â”œâ”€â”€ App.tsx                  # æ ¹ç»„ä»¶
â”‚       â”œâ”€â”€ components/              # UI ç»„ä»¶
â”‚       â”œâ”€â”€ hooks/                   # è‡ªå®šä¹‰ Hooks
â”‚       â”œâ”€â”€ services/                # API æœåŠ¡
â”‚       â”œâ”€â”€ stores/                  # çŠ¶æ€ç®¡ç†
â”‚       â”œâ”€â”€ types/                   # ç±»å‹å®šä¹‰
â”‚       â””â”€â”€ styles/                  # æ ·å¼æ–‡ä»¶
â”œâ”€â”€ centrifugo/                      # Centrifugo é…ç½®
â”‚   â””â”€â”€ config.json                  # Centrifugo é…ç½®æ–‡ä»¶
â”œâ”€â”€ docker-compose.yml               # Docker ç¼–æ’ (å¯é€‰)
â””â”€â”€ README.md                        # é¡¹ç›®è¯´æ˜
```

## 7. æŠ€æœ¯æ ˆ

### åç«¯

- **è¿è¡Œæ—¶**: Node.js 20+
- **æ¡†æ¶**: Express.js
- **è¯­è¨€**: TypeScript
- **JWT**: jsonwebtoken
- **HTTP Client**: axios (è°ƒç”¨ Centrifugo API)
- **UUID**: uuid (ç”Ÿæˆæ¶ˆæ¯ID)

### å‰ç«¯

- **æ¡†æ¶**: React 18+
- **æ„å»ºå·¥å…·**: Vite
- **è¯­è¨€**: TypeScript
- **çŠ¶æ€ç®¡ç†**: Zustand
- **æ ·å¼**: Tailwind CSS
- **Centrifuge SDK**: centrifuge (å®˜æ–¹ JS å®¢æˆ·ç«¯)

### å®æ—¶æœåŠ¡

- **Centrifugo**: v5.x

## 8. æ¶ˆæ¯æ ¼å¼å®šä¹‰

### èŠå¤©æ¶ˆæ¯

```typescript
interface ChatMessage {
  id: string; // UUID
  channel: string; // é¢‘é“åç§°
  type: 'text' | 'image' | 'system';
  content: string; // æ¶ˆæ¯å†…å®¹
  user: {
    id: string;
    name: string;
    avatar?: string;
  };
  timestamp: string; // ISO 8601 æ ¼å¼
  metadata?: Record<string, any>;
}
```

### Join/Leave äº‹ä»¶

```typescript
interface JoinLeaveEvent {
  type: 'join' | 'leave';
  user: {
    id: string;
    name: string;
  };
  channel: string;
  timestamp: string;
}
```

### Presence æ•°æ®

```typescript
interface PresenceInfo {
  client: string; // Centrifugo client ID
  user: string; // ç”¨æˆ· ID
  connInfo: {
    name: string;
    avatar?: string;
  };
  chanInfo?: Record<string, any>;
}
```

## 9. å®‰å…¨è€ƒè™‘

1. **JWT è®¤è¯**: æ‰€æœ‰ WebSocket è¿æ¥éœ€è¦æœ‰æ•ˆçš„ JWT Token
2. **é¢‘é“æƒé™**: é€šè¿‡ subscribe proxy éªŒè¯ç”¨æˆ·åŠ å…¥é¢‘é“çš„æƒé™
3. **æ¶ˆæ¯éªŒè¯**: é€šè¿‡ publish proxy éªŒè¯å’Œæ¸…ç†æ¶ˆæ¯å†…å®¹
4. **CORS é…ç½®**: é™åˆ¶å…è®¸çš„æ¥æºåŸŸå
5. **Rate Limiting**: åç«¯å®ç°æ¶ˆæ¯å‘é€é¢‘ç‡é™åˆ¶
6. **XSS é˜²æŠ¤**: å‰ç«¯å¯¹æ¶ˆæ¯å†…å®¹è¿›è¡Œè½¬ä¹‰å¤„ç†

## 10. éƒ¨ç½²æ¶æ„

### å¼€å‘ç¯å¢ƒ

```
å‰ç«¯å¼€å‘æœåŠ¡å™¨ (localhost:3000)
       â”‚
       â–¼
Centrifugo (localhost:8000)
       â”‚
       â–¼
åç«¯æœåŠ¡ (localhost:3001)
```

### ç”Ÿäº§ç¯å¢ƒ

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Load Balancer â”‚
                    â”‚   (Nginx/ALB)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
        â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend     â”‚   â”‚  Centrifugo   â”‚   â”‚   Backend     â”‚
â”‚  (CDN/Static) â”‚   â”‚  Cluster      â”‚   â”‚   Cluster     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     Redis     â”‚
                    â”‚  (PUB/SUB)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 11. ä¸‹ä¸€æ­¥å®æ–½è®¡åˆ’

1. **Phase 1**: åŸºç¡€è®¾æ–½æ­å»º
   - åˆå§‹åŒ–å‰ç«¯é¡¹ç›® (Vite + React + TypeScript)
   - åˆå§‹åŒ–åç«¯é¡¹ç›® (Express + TypeScript)
   - é…ç½® Centrifugo

2. **Phase 2**: æ ¸å¿ƒåŠŸèƒ½å®ç°
   - ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
   - Centrifugo è¿æ¥ç®¡ç†
   - åŸºç¡€èŠå¤©åŠŸèƒ½

3. **Phase 3**: å®Œå–„åŠŸèƒ½
   - é¢‘é“ç®¡ç†
   - åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
   - æ¶ˆæ¯å†å²

4. **Phase 4**: ä¼˜åŒ–å’Œå®Œå–„
   - UI/UX ä¼˜åŒ–
   - é”™è¯¯å¤„ç†
   - æµ‹è¯•

---

## å‚è€ƒèµ„æº

- [Centrifugo å®˜æ–¹æ–‡æ¡£](https://centrifugal.dev/)
- [Centrifugo GitHub](https://github.com/centrifugal/centrifugo)
- [Centrifuge-JS SDK](https://github.com/centrifugal/centrifuge-js)
- [Proxy Events æ–‡æ¡£](https://centrifugal.dev/docs/server/proxy)
- [Channels é…ç½®](https://centrifugal.dev/docs/server/channels)
